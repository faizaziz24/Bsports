CREATE DATABASE BSPORTS
USE BSPORTS


--TABEL OPERATOR
CREATE TABLE OPERATOR(
KODE_OPERATOR CHAR(5) PRIMARY KEY,
NAMA_OPERATOR VARCHAR (50) NOT NULL,
USERID VARCHAR (20) NOT NULL,
PASS VARCHAR (20) NOT NULL,
LEVEL_OPERATOR VARCHAR (30) NOT NULL
);

--TABEL JENIS BARANG
CREATE TABLE JENIS_BARANG(
KODE_JENIS CHAR(5) PRIMARY KEY,
NAMA_JENIS VARCHAR(50) NOT NULL
);

--TABEL BARANG
CREATE TABLE BARANG(
KODE_BARANG CHAR(5) PRIMARY KEY,
KODE_JENIS CHAR (5) FOREIGN KEY REFERENCES JENIS_BARANG(KODE_JENIS),
NAMA_BARANG VARCHAR (50) NOT NULL,
HARGA NUMERIC (18,0) NOT NULL,
STOK INT NOT NULL
);


--TABEL SUPPLIER
CREATE TABLE SUPPLIER(
KODE_SUP CHAR(5) PRIMARY KEY,
NAMA_SUP VARCHAR (50) NOT NULL,
ALAMAT VARCHAR (100) NOT NULL,
NO_TELP VARCHAR (12) NULL,
EMAIL VARCHAR (50) NOT NULL
);


--TABEL PENJUALAN
CREATE TABLE PENJUALAN(
KODE_JUAL CHAR(5) PRIMARY KEY,
KODE_OPERATOR CHAR(5) FOREIGN KEY REFERENCES OPERATOR(KODE_OPERATOR),
TGL DATETIME NOT NULL,
TOTAL NUMERIC (18,0) NOT NULL
);


--TABEL DETAIL PENJUALAN
CREATE TABLE DETAIL_PENJUALAN(
KODE_JUAL CHAR (5) FOREIGN KEY REFERENCES PENJUALAN (KODE_JUAL),
KODE_BARANG CHAR (5) FOREIGN KEY REFERENCES BARANG (KODE_BARANG),
HARGA_JUAL NUMERIC (18,0) NOT NULL,
JUMLAH INT NOT NULL,
SUB_TOTAL NUMERIC (18,0) NOT NULL
);


--TABEL PEMBELIAN
CREATE TABLE PEMBELIAN(
KODE_BELI CHAR(5) PRIMARY KEY,
KODE_OPERATOR CHAR(5) FOREIGN KEY REFERENCES OPERATOR(KODE_OPERATOR),
KODE_SUP CHAR(5) FOREIGN KEY REFERENCES SUPPLIER(KODE_SUP),
TANGGAL DATETIME
)

--TABEL DETAIL BELI
CREATE TABLE DETAIL_PEMBELIAN(
KODE_BELI CHAR(5) FOREIGN KEY REFERENCES PEMBELIAN(KODE_BELI),
KODE_BARANG CHAR(5) FOREIGN KEY REFERENCES BARANG (KODE_BARANG),
HARGA_BELI NUMERIC (18,0) NOT NULL,
QTY INT NOT NULL,
SUB_TOTAL NUMERIC (18,0) NOT NULL
);

DROP TABLE DETAIL_PEMBELIAN


--INSERT OPERATOR
INSERT INTO OPERATOR VALUES ('OP-01','faiz','faiz','faiz123','admin')
INSERT INTO OPERATOR VALUES ('OP-02','faizal','faizal','faizal123','kasir')
INSERT INTO OPERATOR VALUES ('OP-03','faizaziz','faizaziz','faizaziz123','pemilik')


--INSERT JENIS BARANG
INSERT INTO JENIS_BARANG VALUES ('JN001','SEPATU'),('JN002','KAOS KAKI'),('JN003','JERSEY'),('JN004','TAS')

--INSERT BARANG
INSERT INTO BARANG VALUES ('BR001','JN001','Adidas Original Ace 17.4',759000,20)
INSERT INTO BARANG VALUES ('BR002','JN001','Nike SB Rabona',860000,17)
INSERT INTO BARANG VALUES ('BR003','JN001','Specs Accelerator Infinity Grey',649800,10)
INSERT INTO BARANG VALUES ('BR004','JN001','Specs Diablo Black',299800,30)
INSERT INTO BARANG VALUES ('BR005','JN001','Eangle Marcus',221000,13)

INSERT INTO BARANG VALUES ('BR006','JN002','Yonex 245078bcr',137500,8)
INSERT INTO BARANG VALUES ('BR007','JN002','Specs Optimus',44800,12)
INSERT INTO BARANG VALUES ('BR008','JN002','Adidas X20 Blue',111300,23)
INSERT INTO BARANG VALUES ('BR009','JN002','Rebook Unkle Running',49000,30)
INSERT INTO BARANG VALUES ('BR010','JN002','Linning AWSM',138700,4)

INSERT INTO BARANG VALUES ('BR011','JN003','Persija Retro Training',65400,34)
INSERT INTO BARANG VALUES ('BR012','JN003','Chelsea Kit Home 2018',250000,27)
INSERT INTO BARANG VALUES ('BR013','JN003','Basket NBA Indonesia',285000,45)
INSERT INTO BARANG VALUES ('BR014','JN003','PSS Third Sembada',300000,65)
INSERT INTO BARANG VALUES ('BR015','JN003','SPC 02',55000,16)

INSERT INTO BARANG VALUES ('BR016','JN004','Puma Backpack',599000,3)
INSERT INTO BARANG VALUES ('BR017','JN004','Reebok BR9440',799000,7)
INSERT INTO BARANG VALUES ('BR018','JN004','Adidas B547J',299250,9)
INSERT INTO BARANG VALUES ('BR019','JN004','Consina BK',165750,5)
INSERT INTO BARANG VALUES ('BR020','JN004','Montague Foldable Gym',120000,13)

INSERT INTO SUPPLIER VALUES('S0001','DEWI','BANTUL','082234577666','dewi88@gmail.com')
INSERT INTO SUPPLIER VALUES('S0002','BUDI','SLEMAN','087845638081','budik@gmail.com')

INSERT INTO PENJUALAN VALUES ('PJ001','OP-02','2018/12/13',759000)
INSERT INTO DETAIL_PENJUALAN VALUES ('PJ001','BR001',759000,1,759000)

INSERT INTO PEMBELIAN VALUES ('PB001','OP-03','S0001','2019/01/06')
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR001',740000,1,740000)



--FUNCTION
CREATE FUNCTION FC_KODEJUAL()
RETURNS CHAR(5) AS
BEGIN
	DECLARE @KODEBARU CHAR(5), @AKHIR INT
	SELECT @AKHIR =MAX(RIGHT(KODE_JUAL,2)) FROM PENJUALAN
	IF @AKHIR IS NULL
	SET @AKHIR = 0
	SET @KODEBARU='PJ'+ RIGHT('00'+ CAST(@AKHIR+1 AS VARCHAR (3)),3)
	RETURN @KODEBARU
END

--SELECT & DROP
SELECT DBO.FC_KODEJUAL()
DROP FUNCTION FC_KODEJUAL

CREATE FUNCTION FC_KODEBELI()
RETURNS CHAR(5) AS
BEGIN
	DECLARE @KODEBARU CHAR(5), @AKHIR INT
	SELECT @AKHIR =MAX(RIGHT(KODE_BELI,2)) FROM PEMBELIAN
	IF @AKHIR IS NULL
	SET @AKHIR = 0
	SET @KODEBARU='PB'+ RIGHT('00'+ CAST(@AKHIR+1 AS VARCHAR (3)),3)
	RETURN @KODEBARU
END

--SELECT FC
SELECT DBO.FC_KODEBELI()
DROP FUNCTION FC_IDBELI

--PROCEDURE
CREATE PROC SP_INSERTPENJUALAN (@KO CHAR(5), @TP DATETIME, @TOT NUMERIC (18,2))
AS
BEGIN TRAN
DECLARE @KJ CHAR(5)
	SET @KJ = DBO.FC_KODEJUAL()
INSERT INTO PENJUALAN VALUES (@KJ, @KO, @TP, @TOT)
--SELECT * FROM PESANAN
SELECT @KJ
IF @@ERROR=0
	COMMIT TRANSACTION
ELSE
	ROLLBACK TRANSACTION

--DROP SP--
DROP PROC SP_INSERTPENJUALAN

--SP INSERT PEMBELIAN
CREATE PROC SP_INSERTPEMBELIAN (@KO VARCHAR(5), @KS VARCHAR(5), @TP DATETIME)
AS
BEGIN TRAN
DECLARE @KB VARCHAR(5)
SET @KB = DBO.FC_KODEBELI()
INSERT INTO PEMBELIAN VALUES (@KB, @KO, @KS, @TP)
SELECT @KB
IF @@ERROR=0
	COMMIT TRANSACTION
ELSE
	ROLLBACK TRANSACTION

--DROP SP
DROP PROC SP_INSERTPEMBELIAN

--TRIGGER
CREATE TRIGGER TGUBAHSTOKJUAL ON DETAIL_PENJUALAN
FOR INSERT
AS
DECLARE @KB CHAR(5), @IM CHAR(5),@JML INT
BEGIN TRANSACTION
SELECT @KB = KODE_BARANG ,@JML = JUMLAH FROM INSERTED
UPDATE BARANG SET STOK  = STOK - @JML WHERE KODE_BARANG = @KB
IF @@error=0
 COMMIT TRANSACTION
ELSE
 ROLLBACK TRANSACTION

--DROP
DROP TRIGGER TGUBAHSTOKJUAL

SELECT * FROM DETAIL_PEMBELIAN

CREATE TRIGGER TGUBAHSTOKBELI ON DETAIL_PEMBELIAN
FOR INSERT
AS
DECLARE @KB CHAR(5),@JML INT
BEGIN TRANSACTION
SELECT @KB = KODE_BARANG, @JML = JUMLAH FROM INSERTED
UPDATE BARANG SET STOK  = STOK + @JML WHERE KODE_BARANG = @KB
IF @@error=0
 COMMIT TRANSACTION
ELSE
 ROLLBACK TRANSACTION

--DROP
DROP TRIGGER TGUBAHSTOKJUAL

SELECT * FROM DETAIL_PENJUALAN

INSERT INTO PEMBELIAN VALUES ('PB001','OP-03','S0001','2018/12/21')
INSERT INTO PEMBELIAN VALUES ('PB002','OP-03','S0002','2018/12/22')
INSERT INTO PEMBELIAN VALUES ('PB003','OP-03','S0001','2019/1/1')
INSERT INTO PEMBELIAN VALUES ('PB004','OP-03','S0002','2019/1/2')
  
 --SEPATU
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR001',750000,20,15000000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR002',860000,17,14620000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR003',640000,10,6400000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR004',280000,30,8400000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB001','BR005',210000,13,2730000)

--KAOS KAKI
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB002','BR006',120000,8,960000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB002','BR007',40000,12,480000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB002','BR008',110000,23,2530000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB002','BR009',45000,30,1350000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB002','BR010',135000,4,540000)

--JERSEY
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB003','BR011',60000,34,2040000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB003','BR012',240000,27,6480000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB003','BR013',275000,45,12375000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB003','BR014',290000,65,18850000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB003','BR015',53000,16,848000)

--TAS
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB004','BR016',570000,3,1710000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB004','BR017',750000,7,5250000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB004','BR018',280000,9,2520000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB004','BR019',165000,5,825000)
INSERT INTO DETAIL_PEMBELIAN VALUES ('PB004','BR020',100000,13,1300000)